rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /{anyPath=**}/projects/{projectId} {
      allow read, write: if request.auth != null;
    }

    // ARCHIVES 
    match /archives/{archiveId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /{anyPath=**}/archives/{archiveId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    // STOCK_ITEMS: any signed-in user
    match /stock_items/{id} {
      allow read, write: if request.auth != null;
    }

    // CUSTOMERS & sub-collections
    match /customers/{customerId} {
      allow read, write: if request.auth != null;

      match /projects/{projectId} {
        allow read, write: if request.auth != null;

        match /rw_documents/{docId} {
          allow read, create: if request.auth != null;

          allow update: if request.auth != null
            && (
              request.auth.token.admin == true
              || (
                resource.data.createdAt.year()  == request.time.year()
                && resource.data.createdAt.month() == request.time.month()
                && resource.data.createdAt.day()   == request.time.day()
              )
            );

          allow delete: if request.auth != null
            && request.auth.token.admin == true;
        }

        match /audit_logs/{logId} {
          allow create: if request.auth != null;
          allow read:   if request.auth != null;
        }
      }
    }

    // Top-level PROJECTS
    match /projects/{id} {
      allow read, write: if request.auth != null;
    }

    // Top-level RW_DOCUMENTS (all-RW/MM menu)
    match /rw_documents/{docId} {
      allow read, create: if request.auth != null;
      allow update, delete: if request.auth != null
        && request.auth.token.admin == true;
    }

    // REPORTS
    match /reports/{id} {
      allow read, write: if request.auth != null;
    }

    // CATEGORIES
    match /categories/{id} {
      allow read, write: if request.auth != null;
    }

    // Top-level AUDIT_LOGS
    match /audit_logs/{logId} {
      allow create: if request.auth != null;
      allow read:   if request.auth != null;
    }

    // USERS
    match /users/{userId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      match /favouriteCustomers/{customerId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /favouriteProjects/{projectId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    // METADATA
    match /metadata/{docId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null;
    }

    // CONTACTS
    match /contacts/{contactId} {
      allow read, write: if request.auth != null;
    }

    // CHAT

    function signedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return signedIn() && request.auth.token.admin == true;
    }

    function chatIsMember() {
      return signedIn()
        && resource.data.members is list
        && resource.data.members.hasAny([request.auth.uid]);
    }

    match /chats/{chatId} {
      allow read, write: if signedIn() && chatId == "global";

      allow read: if chatIsMember();

      // Create:
      allow create: if isAdmin()
        || (
          signedIn()
          && request.resource.data.type == "dm"
          && request.resource.data.members is list
          && request.resource.data.members.hasAny([request.auth.uid])
        );

      // - admin or members (keep flexible for now)
      allow update, delete: if isAdmin() || chatIsMember();

      match /messages/{messageId} {

        allow read, write: if signedIn() && chatId == "global";

        allow read, create: if signedIn()
          && exists(/databases/$(database)/documents/chats/$(chatId))
          && get(/databases/$(database)/documents/chats/$(chatId)).data.members.hasAny([request.auth.uid]);

        allow update, delete: if isAdmin();
      }
    }
  }
}
