rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    match /config/{docId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /{anyPath=**}/projects/{projectId} {
      allow read, write: if request.auth != null;
    }

    match /archives/{archiveId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /{anyPath=**}/archives/{archiveId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.token.admin == true;
    }

    match /stock_items/{id} {
      allow read, write: if request.auth != null;
    }

    match /customers/{customerId} {
      allow read, write: if request.auth != null;

      match /projects/{projectId} {
        allow read, write: if request.auth != null;

        match /rw_documents/{docId} {
          allow read, create: if request.auth != null;

          allow update: if request.auth != null
            && (
              request.auth.token.admin == true
              || (
                resource.data.createdAt.year()  == request.time.year()
                && resource.data.createdAt.month() == request.time.month()
                && resource.data.createdAt.day()   == request.time.day()
              )
            );

          allow delete: if request.auth != null
            && request.auth.token.admin == true;
        }

        match /audit_logs/{logId} {
          allow create: if request.auth != null;
          allow read:   if request.auth != null;
        }
      }
    }

    match /projects/{id} {
      allow read, write: if request.auth != null;
    }

    match /rw_documents/{docId} {
      allow read, create: if request.auth != null;
      allow update, delete: if request.auth != null
        && request.auth.token.admin == true;
    }

    match /reports/{id} {
      allow read, write: if request.auth != null;
    }

    match /categories/{id} {
      allow read, write: if request.auth != null;
    }

    match /audit_logs/{logId} {
      allow create: if request.auth != null;
      allow read:   if request.auth != null;
    }

    match /users/{userId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == userId;

      match /favouriteCustomers/{customerId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }

      match /favouriteProjects/{projectId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /push_tokens/{token} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
      match /presence/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }

    match /metadata/{docId} {
      allow read:  if request.auth != null;
      allow write: if request.auth != null;
    }

    match /contacts/{contactId} {
      allow read, write: if request.auth != null;
    }

// CHAT

    function signedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return signedIn() && request.auth.token.admin == true;
    }

    function chatHasMember() {
      return signedIn()
        && resource.data.members is list
        && resource.data.members.hasAny([request.auth.uid]);
    }

    function isMemberOf(chatId) {
      return signedIn()
        && exists(/databases/$(database)/documents/chats/$(chatId))
        && get(/databases/$(database)/documents/chats/$(chatId)).data.members is list
        && get(/databases/$(database)/documents/chats/$(chatId)).data.members.hasAny([request.auth.uid]);
    }

    match /chats/{chatId} {

      // allow your query to run
      allow list: if signedIn();

      // allow reading individual chat docs for signed-in users
      allow get: if signedIn();

      // DM: any signed-in user can create if they're included
      // Group: admin only (and admin must be included)
      allow create: if signedIn()
        && request.resource.data.members is list
        && request.resource.data.members.hasAny([request.auth.uid])
        && (
          request.resource.data.type == "dm"
          || (isAdmin() && request.resource.data.type == "group")
        );

      // IMPORTANT: use resource.data.members (existing doc), not request.resource.data.members
      allow update: if signedIn()
        && (
          isAdmin()
          || chatId == "global"
          || chatHasMember()
        );

      // admin delete only, never global
      allow delete: if isAdmin() && chatId != "global";

      match /messages/{messageId} {
        allow read: if signedIn() && (chatId == "global" || isMemberOf(chatId));

        // IMPORTANT: senderId must match auth uid (matches your code)
        allow create: if signedIn()
          && (chatId == "global" || isMemberOf(chatId))
          && request.resource.data.senderId == request.auth.uid;

        allow update, delete: if isAdmin();
      }
    }
  }
}
